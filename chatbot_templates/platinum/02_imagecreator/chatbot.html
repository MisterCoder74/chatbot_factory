<?php
session_start();

if (!isset($_SESSION['user_id'])) {
    die('User not logged in');
}

// Update last seen (best-effort)
$usersPath = '../../../userdata.json';
$usersRaw = @file_get_contents($usersPath);
$readusers_data = [];
if ($usersRaw !== false) {
    $readusers_data = json_decode($usersRaw, true);
    if (is_array($readusers_data)) {
        foreach ($readusers_data as &$u) {
            if (($u['id'] ?? null) == $_SESSION['user_id']) {
                $u['lastseen_date'] = date('Y-m-d H:i:s');
                $user_data = $u;
                break;
            }
        }
        @file_put_contents($usersPath, json_encode($readusers_data, JSON_PRETTY_PRINT));
    }
}

if (!isset($user_data)) {
    die('User data not found');
}

// Load plans
$plans = json_decode(@file_get_contents('../../../plans.json'), true);
$selectedPlan = null;
foreach ($plans as $plan) {
    if ($plan['plan'] === $user_data['plan_type']) {
        $selectedPlan = $plan;
        break;
    }
}
if (!$selectedPlan) {
    die('Invalid plan type');
}

$configFilePath = './conf.json';
$configContent = @file_get_contents($configFilePath);
$config = json_decode($configContent ?: '[]', true);
if (!is_array($config) || !isset($config[0])) {
    die('Error loading configuration.');
}

$chatbotConfig = $config[0];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    header('Content-Type: application/json');
    $credits = (int)($chatbotConfig['credits_count'] ?? 0);

    if ($credits > 0) {
        $credits -= 1;
        $chatbotConfig['credits_count'] = $credits;
        $config[0] = $chatbotConfig;
        @file_put_contents($configFilePath, json_encode($config, JSON_PRETTY_PRINT));
        echo json_encode(['status' => 'success', 'credits_count' => $credits]);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Insufficient credits.']);
    }
    exit;
}

$backgroundColor = $chatbotConfig['background_color'] ?? '#ffffff';
$styleColor = $chatbotConfig['style_color'] ?? '#0000ff';
$textColor = $chatbotConfig['text_color'] ?? '#000000';
$chatbotName = $chatbotConfig['chatbot_name'] ?? 'Image Creator';
$chatbotHeading = $chatbotConfig['header'] ?? 'Image Generator';
$chatbotId = $chatbotConfig['chatbot_id'] ?? '';
$chatbotKey = $chatbotConfig['chatbot_apikey'] ?? '';
$chatbotImg = !empty($chatbotConfig['img_url']) ? $chatbotConfig['img_url'] : 'default.png';
$creditsCount = (int)($chatbotConfig['credits_count'] ?? 0);

// Resident memory logic (from original)
if ($selectedPlan['plan'] === 'Gold') {
    $hasResidentMemory = true;
    $maxResidentMemoryMB = 20;
} elseif ($selectedPlan['plan'] === 'Platinum') {
    $hasResidentMemory = true;
    $maxResidentMemoryMB = 40;
} else {
    $hasResidentMemory = false;
    $maxResidentMemoryMB = 0;
}

$directory = 'resident_memory';
$files = [];
$totalSize = 0;
if (is_dir($directory)) {
    $files = array_filter(scandir($directory), function($file) {
        return pathinfo($file, PATHINFO_EXTENSION) === 'txt';
    });
    foreach ($files as $file) {
        $totalSize += filesize($directory . '/' . $file);
    }
}
$totalSizeMB = $totalSize / (1024 * 1024);
?>

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><?php echo htmlspecialchars($chatbotName); ?><?php echo $chatbotId ? ' - ' . htmlspecialchars($chatbotId) : ''; ?></title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root {
            --cb-bg: <?php echo htmlspecialchars($backgroundColor); ?>;
            --cb-text: <?php echo htmlspecialchars($textColor); ?>;
            --cb-accent: <?php echo htmlspecialchars($styleColor); ?>;
        }

        body {
            background: var(--cb-bg);
            color: var(--cb-text);
            min-height: 100vh;
        }

        .accent {
            color: var(--cb-accent);
        }

        .btn-accent {
            background: var(--cb-accent);
            border-color: var(--cb-accent);
            color: #fff;
        }

        .btn-accent:hover {
            filter: brightness(0.95);
            color: #fff;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.75);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .loading-overlay img {
            width: 80px;
            height: 80px;
        }

        .card {
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .generated-img-wrapper {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .generated-img-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }

        .history-item {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 2rem;
            margin-bottom: 2rem;
        }

        .history-item:last-child {
            border-bottom: 0;
        }

        .prompt-bubble {
            background: #f1f3f5;
            padding: 12px 16px;
            border-radius: 12px;
            border-bottom-left-radius: 2px;
            display: inline-block;
            max-width: 80%;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
    <img src="preloader.gif" alt="Loading" />
    <div class="mt-3 fw-semibold">Generating HD Imageâ€¦</div>
</div>

<nav class="navbar navbar-expand-lg border-bottom sticky-top" style="background: rgba(255,255,255,0.85); backdrop-filter: blur(10px);">
    <div class="container">
        <div class="d-flex align-items-center gap-3">
            <img src="<?php echo htmlspecialchars($chatbotImg); ?>" alt="Avatar" width="44" height="44" class="rounded-circle border" />
            <div>
                <div class="fw-bold"><?php echo htmlspecialchars($chatbotHeading); ?></div>
                <div class="small text-secondary">Credits: <span id="creditsCount"><?php echo (int)$creditsCount; ?></span></div>
            </div>
        </div>
    </div>
</nav>

<main class="container py-4">
    <div class="row g-4 justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="alert alert-info border-0 shadow-sm">
                <div class="fw-semibold">Image Generator - Generate HD Images with AI</div>
                <div class="small">Describe the image you want to create. The assistant will generate it using advanced AI models.</div>
            </div>
        </div>

        <div class="col-12 col-lg-10">
            <div class="card p-4">
                <label for="user-input" class="form-label fw-semibold">Describe your image</label>
                <textarea id="user-input" class="form-control" rows="3" placeholder="A futuristic cyberpunk city with neon lights and rainy streets, digital art style..."></textarea>
                
                <div class="row mt-3 g-3">
                    <div class="col-12 col-md-6">
                        <label for="modelSelect" class="form-label small fw-semibold">AI Model</label>
                        <select id="modelSelect" class="form-select" onchange="updateSizeOptions()">
                            <option value="dall-e-2">DALL-E 2 (Standard)</option>
                            <?php if ($selectedPlan['plan'] !== 'Free' && $selectedPlan['plan'] !== 'Silver'): ?>
                            <option value="dall-e-3">DALL-E 3 (High Definition)</option>
                            <?php endif; ?>
                        </select>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="sizeSelect" class="form-label small fw-semibold">Image Size</label>
                        <select id="sizeSelect" class="form-select"></select>
                    </div>
                </div>

                <div class="mt-4">
                    <button id="generateBtn" class="btn btn-accent px-4 py-2" onclick="generateImage()">
                        Generate Image
                    </button>
                </div>
                <div id="errorBox" class="alert alert-danger mt-3 d-none"></div>
            </div>
        </div>

        <div class="col-12 col-lg-10 mt-5">
            <h5 class="fw-bold mb-4">Generation History</h5>
            <div id="chat-container">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const plan = <?php echo json_encode($selectedPlan['plan']); ?>;
    const apikey = <?php echo json_encode($chatbotKey); ?>;
    
    const sizeOptions = {
        'dall-e-2': ['256x256', '512x512'],
        'dall-e-3': ['1024x1024']
    };

    const els = {
        userInput: document.getElementById('user-input'),
        modelSelect: document.getElementById('modelSelect'),
        sizeSelect: document.getElementById('sizeSelect'),
        generateBtn: document.getElementById('generateBtn'),
        chatContainer: document.getElementById('chat-container'),
        errorBox: document.getElementById('errorBox'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        creditsCount: document.getElementById('creditsCount')
    };

    function updateSizeOptions() {
        const selectedModel = els.modelSelect.value;
        let options = [];

        if (plan !== 'Gold' && plan !== 'Platinum') {
            options = sizeOptions['dall-e-2'];
        } else {
            options = sizeOptions[selectedModel] || sizeOptions['dall-e-2'];
        }

        els.sizeSelect.innerHTML = '';
        options.forEach(size => {
            const opt = document.createElement('option');
            opt.value = size;
            opt.textContent = size;
            els.sizeSelect.appendChild(opt);
        });
    }

    function setLoading(isLoading) {
        els.loadingOverlay.style.display = isLoading ? 'flex' : 'none';
        els.loadingOverlay.setAttribute('aria-hidden', isLoading ? 'false' : 'true');
        els.generateBtn.disabled = isLoading;
    }

    function showError(message) {
        els.errorBox.textContent = message;
        els.errorBox.classList.remove('d-none');
        els.errorBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function clearError() {
        els.errorBox.classList.add('d-none');
        els.errorBox.textContent = '';
    }

    async function decrementCredits() {
        const res = await fetch(window.location.href, {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await res.json().catch(() => null);
        if (!data || data.status !== 'success') {
            throw new Error(data?.message || 'Unable to update credits.');
        }
        els.creditsCount.textContent = data.credits_count;
    }

    async function generateImage() {
        clearError();
        const prompt = els.userInput.value.trim();
        if (!prompt) {
            showError('Please enter an image description.');
            return;
        }

        if (!apikey) {
            showError('Missing API key. Please add it from the Edit Chatbot page.');
            return;
        }

        setLoading(true);

        try {
            await decrementCredits();

            const response = await fetch("https://api.openai.com/v1/images/generations", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + apikey
                },
                body: JSON.stringify({
                    model: els.modelSelect.value,
                    prompt: prompt,
                    n: 1,
                    size: els.sizeSelect.value
                })
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data?.error?.message || 'OpenAI request failed.');
            }

            const imageUrl = data.data[0].url;
            addHistoryItem(prompt, imageUrl, els.modelSelect.value, els.sizeSelect.value);
            els.userInput.value = '';

        } catch (error) {
            showError(error.message || 'An error occurred during generation.');
        } finally {
            setLoading(false);
        }
    }

    function addHistoryItem(prompt, url, model, size) {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <div class="prompt-bubble shadow-sm">
                <div class="fw-bold small mb-1 accent">Your Prompt</div>
                <div>${escapeHtml(prompt)}</div>
            </div>
            <div class="generated-img-wrapper shadow-sm mt-2" style="max-width: 512px;">
                <img src="${url}" alt="Generated Image" loading="lazy" />
                <div class="p-3 bg-white d-flex justify-content-between align-items-center border-top">
                    <span class="small text-secondary fw-medium">${model.toUpperCase()} &bull; ${size}</span>
                    <a href="${url}" target="_blank" download="generated_image.png" class="btn btn-sm btn-outline-secondary">Download</a>
                </div>
            </div>
        `;
        els.chatContainer.prepend(item);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function verifyEnter(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            generateImage();
        }
    }

    els.userInput.addEventListener('keydown', verifyEnter);
    window.onload = updateSizeOptions;
</script>

</body>
</html>
