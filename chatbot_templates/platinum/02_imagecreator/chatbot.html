<?php
session_start();

// Controllo sessione e caricamento dati utente
if (!isset($_SESSION["user_id"])) {
die("User not logged in");
}

// Carica i dati utente da userdata.json
$user_data_json = file_get_contents('../../../userdata.json');
//echo ($user_data_json);
$readusers_data = json_decode($user_data_json, true);

$user_found = false;
$user_data = null;

// Trova l'utente loggato e aggiorna lastseen_date
foreach ($readusers_data as &$user) {
if ($user['id'] == $_SESSION["user_id"]) {
$user_data = $user;
$user_found = true;

// Aggiorna ultima visualizzazione
$user['lastseen_date'] = date("Y-m-d H:i:s");
break;
}
}
if (!$user_found) {
die("User data not found");
}

// Carica i piani e trova quello dell'utente
$plans = json_decode(file_get_contents('../../../plans.json'), true);
$selectedPlan = null;
foreach ($plans as $plan) {
if ($plan['plan'] === $user_data["plan_type"]) {
$selectedPlan = $plan;
break;
}
}
if (!$selectedPlan) {
die("Invalid plan type");
}

$configFilePath = './conf.json';
$configContent = file_get_contents($configFilePath);
$config = json_decode($configContent, true);

// Verifica che il file sia stato caricato correttamente
if ($config === null || !isset($config[0])) {
die("Errore nel caricamento del file di configurazione.");
}

// Estrai le proprietà necessarie dal primo oggetto dell'array
$chatbotConfig = $config[0]; // Ottieni il primo (e unico) oggetto dell'array

// Se la richiesta è di aggiornare i crediti
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
// Verifica se ci sono ancora crediti disponibili
if ($chatbotConfig['credits_count'] > 0) {
// Scala i crediti di 1
$chatbotConfig['credits_count'] -= 1;

// Aggiorna il file di configurazione
$config[0] = $chatbotConfig; // Riporta l'oggetto aggiornato nell'array
file_put_contents($configFilePath, json_encode($config, JSON_PRETTY_PRINT));

// Risposta JSON di successo
echo json_encode(['status' => 'success', 'credits_count' => $chatbotConfig['credits_count']]);
} else {
// Risposta JSON di errore sui crediti insufficienti
echo json_encode(['status' => 'error', 'message' => 'Crediti insufficienti.']);
}
exit; // Esci dopo aver gestito la richiesta POST
}

// Estrai le proprietà necessarie
$backgroundColor = isset($chatbotConfig['background_color']) ? $chatbotConfig['background_color'] : '#ffffff';
$styleColor = isset($chatbotConfig['style_color']) ? $chatbotConfig['style_color'] : '#0000ff';
$textColor = isset($chatbotConfig['text_color']) ? $chatbotConfig['text_color'] : '#000000';
$chatbotName = $chatbotConfig['chatbot_name'];
$chatbotHeading = $chatbotConfig['header'];
$chatbotId = $chatbotConfig['chatbot_id'];
$chatbotKey = $chatbotConfig['chatbot_apikey'];
$chatbotImg = (!empty($chatbotConfig['img_url'])) ? $chatbotConfig['img_url'] : 'default.png';


function getFullPath() {
// Ottieni il protocollo HTTP o HTTPS
$protocol =  "https://" ;

// Ottieni il nome del server
$host = $_SERVER['HTTP_HOST'];

// Ottieni il percorso della cartella corrente
$currentPath = rtrim(dirname($_SERVER['PHP_SELF']), '/');

// Combina le parti per formare il percorso completo
$fullPath = $protocol . $host . $currentPath;

return $fullPath;
}


// Definizione di variabili per resident memory
if ($selectedPlan['plan'] === 'Gold') {
$hasResidentMemory = true;
$maxResidentMemoryMB = 20; // MB
} elseif ($selectedPlan['plan'] === 'Platinum') {
$hasResidentMemory = true;
$maxResidentMemoryMB = 40; // MB
} else {
$hasResidentMemory = false;
$maxResidentMemoryMB = 0; // Nessuno spazio
}

// Conto chatbot e personas dell'utente
$chatbot_count = is_array($user_data["chatbots"]) ? count($user_data["chatbots"]) : 0;
$persona_count = is_array($user_data["personas"]) ? count($user_data["personas"]) : 0;

// Verifica limiti
$can_create_chatbot = ($chatbot_count < $selectedPlan['allowed_chatbots']);
$can_have_persona = ($selectedPlan['plan'] === 'Gold' || $selectedPlan['plan'] === 'Platinum');
$can_create_persona = ($persona_count < $selectedPlan['personas']);

// Calcolo spazio occupato in MB della resident memory
$directory = 'resident_memory';
$files = [];
$totalSize = 0;

if (is_dir($directory)) {
// Scansione dei file .txt
$files = array_filter(scandir($directory), function($file) {
return pathinfo($file, PATHINFO_EXTENSION) === 'txt';
});

// Calcolo totale dimensione
foreach ($files as $file) {
$totalSize += filesize($directory . '/' . $file);
}
}
// Conversione in MB
$totalSizeMB = $totalSize / (1024 * 1024);

$showFileList = !empty($files); // Verifica se ci sono file
// Variabile di controllo per spazio residuo
$hasSpace = true;

if ($hasResidentMemory) {
// Imposta soglie di avviso (5MB prima del limite)
$warningThresholdMB = 5;

// Se lo spazio residuo è sotto la soglia
if ($totalSizeMB >= ($maxResidentMemoryMB - $warningThresholdMB) && $totalSizeMB < $maxResidentMemoryMB) {
$remaining = round($maxResidentMemoryMB - $totalSizeMB, 2);
echo "<script>alert('Attenzione: spazio residuo limitato (" . $remaining . " MB rimanenti).');</script>";
}
// Se lo spazio totale occupato ha raggiunto o superato il limite
elseif ($totalSizeMB >= $maxResidentMemoryMB) {
$hasSpace = false;
echo "<script>
if (document.getElementById('savetodisk')) {
document.getElementById('savetodisk').disabled = true;
}
alert('Limite di spazio raggiunto (" . $maxResidentMemoryMB . " MB). Si prega di cancellare vecchie chat dalla resident memory.');
</script>";
}
}

// Salvataggio aggiornamenti userdata
file_put_contents('../../../userdata.json', json_encode($readusers_data, JSON_PRETTY_PRINT));
?>

<!DOCTYPE html>
<html>
<head>
<title><?php echo $chatbotName; ?> - <?php echo $chatbotId; ?></title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<meta name="Description" CONTENT="">

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
background: <?php echo $backgroundColor; ?>;
color: <?php echo $textColor; ?>;
height: 100%;
}
.fixedhead {
background-color: <?php echo $styleColor; ?>;
padding: .5rem 0;        
height: auto;
width: 100%;
display: flex;
border: 1px solid <?php echo $styleColor; ?>;        
flex-direction: column;
align-items: center;        
}   
        
nav {
display: flex;
justify-content: space-between;
align-items: center;
flex-direction: column;
align-items: center;  
height: auto;        
} 
        
nav h2 {
font-size: 1.8rem;
        margin: .5rem auto;
}        
        
.userinput {
  margin: 8px auto;
  background-color: white;
  padding: 10px;
  z-index: 9999;
  width: 100%;
  height: auto;      
  box-shadow: 0 4px 10px <?php echo $styleColor; ?>;
}
nav img {
        display: block;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        box-shadow: 0 2px 8px <?php echo $styleColor; ?>;
        }        

select {
font-size: 1rem;
color: black;
border-radius: 10px;
box-shadow: 0px 4px 10px <?php echo $styleColor; ?>;
padding: 8px;
width: 8rem;
margin: 1rem auto;
        }
       
.preloader {
  width: 48px;
}         
      
        
.user-message {
background-color: <?php echo $styleColor; ?>;
padding: 10px;
border: 1px solid black;
color: <?php echo $textColor; ?>;
font-size: 1rem;
border-radius: 5px;
margin-bottom: 4px;
}

.chatbot-message {
background-color: <?php echo $styleColor; ?>;
padding: 15px;
color: <?php echo $textColor; ?>;
font-size: 1rem;
border: 1px solid black;
border-radius: 5px;
margin-bottom: 10px;
display: flex;
justify-content: space-between;
align-items: start;
}
.chatbot-message-vertical {
background-color: <?php echo $styleColor; ?>;
padding: 15px;
color: <?php echo $textColor; ?>;
font-size: 1rem;
border: 1px solid black;
border-radius: 5px;
margin-bottom: 10px;
display: flex;
        flex-direction: column;
justify-content: space-between;
align-items: start;
}        
        
button {
background-color: <?php echo $styleColor; ?>;
color: <?php echo $textColor; ?>;
cursor: pointer;
padding: 8px 14px;
margin: 2px 4px;        
font-size: 1.2rem;
border-radius: 8px;
border: 1px solid black;
}  
 
.btnShimmer {
        box-shadow: 0 1px 4px <?php echo $textColor; ?>;
        }
.btnShimmer:hover {
        background-color: <?php echo $textColor; ?>;
        color: <?php echo $styleColor; ?>;
        } 

        
.chathistory {
  padding: 10px;
  width: 100%;
  height: 75%;
  overflow-y: auto;
  
}

#chat-container {
height: 100%;
width: 100%;
padding: 10px;
}
.generatedimg {
max-width: 390px
height: auto;
box-shadow: 0 2px 8px <?php echo $styleColor; ?>;
}        
        

input {
font-size: 1.2rem;
color: black;
border-radius: 10px;
box-shadow: 0px 4px 10px grey;
padding: 8px;
width: 80%;
margin: 0 auto;
}        
</style>
</head>
<body>

<section class="fixedhead">
<nav>
<h2><?php echo $chatbotName; ?></h2>
<h2><?php echo $chatbotHeading; ?></h2>        
<img src= "<?php echo $chatbotImg; ?>">          
</nav>
<div class="userinput">        
<input type="text" id="user-input" placeholder="Type a message..." onkeydown="verifyEnter(event)" />
        <br>
<!-- Model selection -->
<label for="modelSelect">Model:</label>
<select id="modelSelect" onchange="updateSizeOptions()">
<option value="dall-e-2">DALL-E 2</option>
<?php if ($selectedPlan['plan'] !== 'Free' && $selectedPlan['plan'] !== 'Silver'): ?>
<option value="dall-e-3">DALL-E 3</option>
<?php endif; ?>
</select>

<!-- Size selection, qui le opzioni vengono popolate in JS -->
<label for="sizeSelect">Image Size:</label>
<select id="sizeSelect"></select>      
<button onclick="generateImage()">Send</button>
</div>        
</section>


<script>
const plan = "<?php echo $selectedPlan['plan']; ?>"; // esempio: 'Free', 'Gold', etc.

// tutte le possibili dimensioni
const sizeOptions = {
'dall-e-2': ['256x256', '512x512'],
'dall-e-3': ['1024x1024']
};

function updateSizeOptions() {
const modelSelect = document.getElementById('modelSelect');
const sizeSelect = document.getElementById('sizeSelect');
const selectedModel = modelSelect.value;

let options = [];

if (plan !== 'Gold' && plan !== 'Platinum') {
// Solo dall-e-2 con risoluzioni basse
if (selectedModel === 'dall-e-2') {
options = sizeOptions['dall-e-2'];
} else {
// Se selezioni dall-e-3, ma piano non supporta (ad esempio ricerca errata)
options = sizeOptions['dall-e-2'];
}
} else {
// Piani Gold/Platinum
if (selectedModel === 'dall-e-2') {
options = sizeOptions['dall-e-2'];
} else if (selectedModel === 'dall-e-3') {
options = sizeOptions['dall-e-3'];
}
}

// Ricostruisci le opzioni
sizeSelect.innerHTML = '';
options.forEach(function(size) {
const opt = document.createElement('option');
opt.value = size;
opt.textContent = size;
sizeSelect.appendChild(opt);
});
}

// Imposta le opzioni di default al caricamento
window.onload = updateSizeOptions;
</script>
        
<section class="chathistory">
<div id="chat-container"></div>
</section>        




<script>
// Rendere le proprietà disponibili in JavaScript
const config = <?php echo json_encode($chatbotConfig); ?>;

function verifyEnter(event) {
if (event.keyCode === 13) {
event.preventDefault();
sendMessage();
}
}
        
const modelSelect = document.getElementById('modelSelect');
const sizeSelect = document.getElementById('sizeSelect');
const selectedModel = modelSelect.value;      
        

        
async function generateImage() {
  const selectedSize = sizeSelect.value;      
  const apikey = "<?php echo ($chatbotKey); ?>";       
  console.log(apikey);
  const prompt = document.getElementById("user-input").value;
  const chatContainer = document.getElementById("chat-container");
  const promptDiv = document.createElement("div");
  promptDiv.classList.add("user-message");
  promptDiv.textContent = `Prompt: ${prompt}`;
  chatContainer.appendChild(promptDiv);

  const typingIndicator = document.createElement("p");
  typingIndicator.id = "typing-indicatorIMG";
  typingIndicator.innerHTML =
    '<img src="preloader.gif" class="preloader" alt="Loading...">';
  chatContainer.appendChild(typingIndicator);

  try {
    const response = await fetch(
      "https://api.openai.com/v1/images/generations",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + apikey
        },
        body: JSON.stringify({
          model:  selectedModel,
          prompt: prompt,
          n: 1,
          size: selectedSize
        })
      }
    );
console.log(selectedSize);
    const data = await response.json();
          console.log(data);
    const imageUrl = data.data[0].url;

    const responseDiv = document.createElement("div");
    responseDiv.classList.add("chatgpt-message");
    const image = document.createElement("img");
    image.src = imageUrl;
    image.alt = "Generated Image";
    image.classList.add("generatedimg");
    responseDiv.appendChild(image);


          
const downloadLink = document.createElement("a");
const spacer = document.createElement("br");
downloadLink.href = imageUrl;
downloadLink.target = "_blank";
downloadLink.textContent = "Download Image";
responseDiv.appendChild(spacer);
responseDiv.appendChild(downloadLink);



    chatContainer.removeChild(typingIndicator);
    chatContainer.appendChild(responseDiv);
  } catch (error) {
    console.error(error);
    alert(
      "An error occurred during the request. Check your OpenAI account or try later."
    );
  }
}        
  
   
        
</script>

</body>
</html>