<?php
session_start();

if (!isset($_SESSION['user_id'])) {
    die('User not logged in');
}

// Update last seen (best-effort)
$usersPath = '../../../userdata.json';
$usersRaw = @file_get_contents($usersPath);
if ($usersRaw !== false) {
    $users = json_decode($usersRaw, true);
    if (is_array($users)) {
        foreach ($users as &$u) {
            if (($u['id'] ?? null) == $_SESSION['user_id']) {
                $u['lastseen_date'] = date('Y-m-d H:i:s');
                break;
            }
        }
        @file_put_contents($usersPath, json_encode($users, JSON_PRETTY_PRINT));
    }
}

$configFilePath = './conf.json';
$configContent = @file_get_contents($configFilePath);
$config = json_decode($configContent ?: '[]', true);
if (!is_array($config) || !isset($config[0])) {
    die('Error loading configuration.');
}

$chatbotConfig = $config[0];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && ($_POST['action'] ?? '') === 'decrement_credits') {
    header('Content-Type: application/json');

    $amount = (int)($_POST['amount'] ?? 1);
    $amount = max(1, min(50, $amount));

    $credits = (int)($chatbotConfig['credits_count'] ?? 0);

    if ($credits < $amount) {
        echo json_encode([
            'status' => 'error',
            'message' => 'Insufficient credits.',
            'credits_count' => $credits
        ]);
        exit;
    }

    $credits -= $amount;
    $chatbotConfig['credits_count'] = $credits;
    $config[0] = $chatbotConfig;
    @file_put_contents($configFilePath, json_encode($config, JSON_PRETTY_PRINT));

    echo json_encode(['status' => 'success', 'credits_count' => $credits]);
    exit;
}

$backgroundColor = $chatbotConfig['background_color'] ?? '#ffffff';
$styleColor = $chatbotConfig['style_color'] ?? '#ff0066';
$textColor = $chatbotConfig['text_color'] ?? '#000000';
$chatbotName = $chatbotConfig['chatbot_name'] ?? 'SEO Optimizer';
$chatbotHeading = $chatbotConfig['header'] ?? 'SEO Optimizer';
$chatbotId = $chatbotConfig['chatbot_id'] ?? '';
$chatbotKey = $chatbotConfig['chatbot_apikey'] ?? '';
$chatbotImg = !empty($chatbotConfig['img_url']) ? $chatbotConfig['img_url'] : 'default.png';
$creditsCount = (int)($chatbotConfig['credits_count'] ?? 0);
?>

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><?php echo htmlspecialchars($chatbotName); ?><?php echo $chatbotId ? ' - ' . htmlspecialchars($chatbotId) : ''; ?></title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root {
            --cb-bg: <?php echo htmlspecialchars($backgroundColor); ?>;
            --cb-text: <?php echo htmlspecialchars($textColor); ?>;
            --cb-accent: <?php echo htmlspecialchars($styleColor); ?>;
        }

        body {
            background: var(--cb-bg);
            color: var(--cb-text);
        }

        .btn-accent {
            background: var(--cb-accent);
            border-color: var(--cb-accent);
            color: #fff;
        }
        .btn-accent:hover { filter: brightness(0.95); color: #fff; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
        }
        .loading-overlay img {
            width: 76px;
            height: 76px;
        }

        .badge-good { background: #198754; }
        .badge-warning { background: #ffc107; color: #111; }
        .badge-critical { background: #dc3545; }

        .report-box {
            background: #fff;
            border: 1px solid rgba(0,0,0,.12);
            border-radius: 12px;
            padding: 12px;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
    <img src="preloader.gif" alt="Loading" />
    <div class="mt-3 fw-semibold" id="loadingText">Working…</div>
</div>

<nav class="navbar navbar-expand-lg border-bottom" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(6px);">
    <div class="container">
        <div class="d-flex align-items-center gap-3">
            <img src="<?php echo htmlspecialchars($chatbotImg); ?>" alt="Avatar" width="44" height="44" class="rounded-circle" />
            <div>
                <div class="fw-bold"><?php echo htmlspecialchars($chatbotHeading); ?></div>
                <div class="small text-secondary">Credits: <span id="creditsCount"><?php echo (int)$creditsCount; ?></span></div>
            </div>
        </div>
    </div>
</nav>

<main class="container py-4">
    <div class="row g-4">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="fw-semibold">Analyze a website and get prioritized SEO recommendations</div>
                <div class="small">Enter a URL. We fetch key on-page signals (title, meta description, headings, images, content snippet) and generate an SEO report.</div>
            </div>
        </div>

        <div class="col-12">
            <label class="form-label fw-semibold" for="url">Website URL</label>
            <input id="url" class="form-control" placeholder="https://example.com" />
            <div class="d-flex flex-wrap gap-2 mt-3">
                <button id="analyzeBtn" class="btn btn-accent">Analyze Website</button>
                <button id="reanalyzeBtn" class="btn btn-outline-secondary" disabled>Reanalyze</button>
                <button id="exportPdfBtn" class="btn btn-outline-secondary" disabled>Export as PDF</button>
                <button id="downloadTxtBtn" class="btn btn-outline-secondary" disabled>Download Report as Text</button>
            </div>
            <div id="errorBox" class="alert alert-danger mt-3 d-none"></div>
        </div>

        <div class="col-12">
            <div class="report-box">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <div class="fw-semibold">Current SEO score</div>
                        <div class="small text-secondary" id="scoreLabel">—</div>
                    </div>
                    <div style="min-width: 280px;" class="flex-grow-1">
                        <div class="progress" role="progressbar" aria-label="SEO score" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <div id="scoreBar" class="progress-bar" style="width: 0%">0</div>
                        </div>
                    </div>
                </div>

                <hr />

                <div class="fw-semibold mb-2">Findings</div>
                <div class="accordion" id="findingsAccordion"></div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrm3AhYF4XMEbL6YVZixoaSuXlfttYQOUxiSwcA6UuN1ckvAjsaJ5jWBKzwX7cfp83q+giP7dZr2XU0QIDAQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    const OPENAI_API_KEY = <?php echo json_encode($chatbotKey); ?>;

    const els = {
        url: document.getElementById('url'),
        analyzeBtn: document.getElementById('analyzeBtn'),
        reanalyzeBtn: document.getElementById('reanalyzeBtn'),
        exportPdfBtn: document.getElementById('exportPdfBtn'),
        downloadTxtBtn: document.getElementById('downloadTxtBtn'),
        errorBox: document.getElementById('errorBox'),
        scoreBar: document.getElementById('scoreBar'),
        scoreLabel: document.getElementById('scoreLabel'),
        findingsAccordion: document.getElementById('findingsAccordion'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        loadingText: document.getElementById('loadingText'),
        creditsCount: document.getElementById('creditsCount')
    };

    let lastUrl = '';
    let lastReport = null;

    function setLoading(isLoading, text = 'Working…') {
        els.loadingOverlay.style.display = isLoading ? 'flex' : 'none';
        els.loadingOverlay.setAttribute('aria-hidden', isLoading ? 'false' : 'true');
        els.loadingText.textContent = text;
        els.analyzeBtn.disabled = isLoading;
        els.reanalyzeBtn.disabled = isLoading || !lastUrl;
        els.exportPdfBtn.disabled = isLoading || !lastReport;
        els.downloadTxtBtn.disabled = isLoading || !lastReport;
    }

    function showError(message) {
        els.errorBox.textContent = message;
        els.errorBox.classList.remove('d-none');
    }

    function clearError() {
        els.errorBox.classList.add('d-none');
        els.errorBox.textContent = '';
    }

    async function fetchWithTimeout(url, options = {}, timeoutMs = 120000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
            return res;
        } finally {
            clearTimeout(timeoutId);
        }
    }

    async function decrementCredits(amount = 1) {
        const formData = new FormData();
        formData.append('action', 'decrement_credits');
        formData.append('amount', String(amount));

        const res = await fetchWithTimeout(window.location.href, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        }, 30000);

        const data = await res.json().catch(() => null);
        if (!data || data.status !== 'success') {
            const msg = data?.message || 'Unable to update credits.';
            throw new Error(msg);
        }

        els.creditsCount.textContent = String(data.credits_count);
    }

    function validateUrl(input) {
        let u;
        try {
            u = new URL(input);
        } catch {
            return null;
        }
        if (!['http:', 'https:'].includes(u.protocol)) return null;
        return u.toString();
    }

    function statusToBadgeClass(status) {
        const s = String(status || '').toLowerCase();
        if (s.includes('critical')) return 'badge-critical';
        if (s.includes('warn')) return 'badge-warning';
        return 'badge-good';
    }

    function clampScore(n) {
        const x = Number(n);
        if (!Number.isFinite(x)) return 0;
        return Math.max(0, Math.min(100, Math.round(x)));
    }

    function renderScore(score) {
        const s = clampScore(score);
        els.scoreBar.style.width = `${s}%`;
        els.scoreBar.textContent = String(s);
        els.scoreBar.parentElement.setAttribute('aria-valuenow', String(s));

        if (s >= 80) {
            els.scoreBar.className = 'progress-bar bg-success';
            els.scoreLabel.textContent = 'Good – minor improvements recommended';
        } else if (s >= 55) {
            els.scoreBar.className = 'progress-bar bg-warning text-dark';
            els.scoreLabel.textContent = 'Average – several improvements recommended';
        } else {
            els.scoreBar.className = 'progress-bar bg-danger';
            els.scoreLabel.textContent = 'Poor – urgent improvements recommended';
        }
    }

    function renderFindings(categories) {
        els.findingsAccordion.innerHTML = '';
        const cats = Array.isArray(categories) ? categories : [];
        if (!cats.length) {
            els.findingsAccordion.innerHTML = '<div class="text-secondary">No findings available.</div>';
            return;
        }

        cats.forEach((cat, idx) => {
            const id = `cat_${idx}`;
            const status = cat?.status || 'Good';
            const badgeClass = statusToBadgeClass(status);
            const score = cat?.score != null ? ` • Score: ${clampScore(cat.score)}` : '';

            const items = Array.isArray(cat?.items) ? cat.items : [];
            const itemsHtml = items.length ? items.map((it) => {
                const st = it?.status || 'Good';
                const bc = statusToBadgeClass(st);
                const issue = it?.issue || '';
                const rec = it?.recommendation || '';
                return `
                    <div class="border rounded-3 p-3 mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge ${bc}">${st}</span>
                            <div class="fw-semibold">${issue}</div>
                        </div>
                        <div class="mt-2 small">${rec}</div>
                    </div>
                `;
            }).join('') : '<div class="text-secondary">No issues detected.</div>';

            const el = document.createElement('div');
            el.className = 'accordion-item';
            el.innerHTML = `
                <h2 class="accordion-header" id="heading_${id}">
                    <button class="accordion-button ${idx === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_${id}" aria-expanded="${idx === 0 ? 'true' : 'false'}" aria-controls="collapse_${id}">
                        <span class="me-2">${cat?.name || 'Category'}</span>
                        <span class="badge ${badgeClass}">${status}</span>
                        <span class="small text-secondary ms-2">${score}</span>
                    </button>
                </h2>
                <div id="collapse_${id}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" aria-labelledby="heading_${id}" data-bs-parent="#findingsAccordion">
                    <div class="accordion-body">
                        ${itemsHtml}
                    </div>
                </div>
            `;
            els.findingsAccordion.appendChild(el);
        });
    }

    function buildTextReport(url, report) {
        const lines = [];
        lines.push(`SEO Report for: ${url}`);
        lines.push('');
        lines.push(`Score: ${clampScore(report?.seo_score)}/100`);
        if (report?.summary) {
            lines.push('');
            lines.push('Summary:');
            lines.push(String(report.summary));
        }

        const categories = Array.isArray(report?.categories) ? report.categories : [];
        if (categories.length) {
            lines.push('');
            lines.push('Findings:');
            lines.push('');
            categories.forEach((cat) => {
                lines.push(`- ${cat?.name || 'Category'} (${cat?.status || 'Good'})`);
                const items = Array.isArray(cat?.items) ? cat.items : [];
                items.forEach((it) => {
                    lines.push(`  * [${it?.status || 'Good'}] ${it?.issue || ''}`);
                    if (it?.recommendation) lines.push(`    - ${it.recommendation}`);
                });
                lines.push('');
            });
        }

        return lines.join('\n');
    }

    async function exportPdf() {
        if (!lastReport || !lastUrl) return;
        const text = buildTextReport(lastUrl, lastReport);

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });

        const margin = 40;
        const maxWidth = 515;
        const lines = doc.splitTextToSize(text, maxWidth);
        doc.text(lines, margin, margin);
        doc.save('seo_report.pdf');
    }

    function downloadText() {
        if (!lastReport || !lastUrl) return;
        const text = buildTextReport(lastUrl, lastReport);
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'seo_report.txt';
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);
    }

    async function analyze() {
        clearError();

        if (!OPENAI_API_KEY || !OPENAI_API_KEY.trim()) {
            showError('Missing OpenAI API key. Please add it from the Edit Chatbot page.');
            return;
        }

        const validated = validateUrl(els.url.value.trim());
        if (!validated) {
            showError('Please enter a valid http/https URL.');
            return;
        }

        lastUrl = validated;
        els.reanalyzeBtn.disabled = false;

        setLoading(true, 'Fetching webpage…');

        try {
            const res = await fetchWithTimeout(`fetch_webpage.php?url=${encodeURIComponent(validated)}`, {
                method: 'GET',
                credentials: 'same-origin'
            }, 45000);

            const pageData = await res.json().catch(() => null);
            if (!res.ok || !pageData || pageData.status !== 'success') {
                const msg = pageData?.message || `Failed to fetch webpage (HTTP ${res.status}).`;
                throw new Error(msg);
            }

            await decrementCredits(1);

            setLoading(true, 'Analyzing SEO…');

            const schemaHint = {
                seo_score: 0,
                summary: '...',
                categories: [
                    {
                        name: 'Meta Tags Optimization',
                        status: 'Good',
                        score: 0,
                        items: [
                            { status: 'Good', issue: '...', recommendation: '...' }
                        ]
                    }
                ]
            };

            const body = {
                model: 'gpt-4o-mini',
                messages: [
                    {
                        role: 'system',
                        content: 'You are an expert SEO auditor. Return ONLY valid JSON (no markdown, no code fences). Prioritize actionable recommendations. Use statuses: Good, Warning, Critical.'
                    },
                    {
                        role: 'user',
                        content: `Analyze this webpage data and produce a structured SEO report.\n\nURL: ${validated}\nTitle: ${pageData.title}\nMeta description: ${pageData.description}\nHeadings: ${JSON.stringify(pageData.headings)}\nImages: ${pageData.images}\nContent length: ${pageData.content_length}\nContent snippet:\n${pageData.content_snippet}\n\nReturn JSON matching this schema (keys must match):\n${JSON.stringify(schemaHint, null, 2)}\n\nInclude these categories (at least):\n- Meta Tags Optimization\n- Heading Structure\n- Keyword Analysis\n- Content Quality\n- Technical SEO\n- Performance` 
                    }
                ],
                temperature: 0.4,
                max_tokens: 1400
            };

            const aiRes = await fetchWithTimeout('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify(body)
            }, 120000);

            const payload = await aiRes.json().catch(() => null);
            if (!aiRes.ok) {
                const msg = payload?.error?.message || `OpenAI request failed (HTTP ${aiRes.status}).`;
                throw new Error(msg);
            }

            const content = payload?.choices?.[0]?.message?.content || '';
            let report;
            try {
                report = JSON.parse(content);
            } catch {
                throw new Error('Invalid AI response format (expected JSON). Please try again.');
            }

            lastReport = report;
            renderScore(report?.seo_score);
            renderFindings(report?.categories);

            els.exportPdfBtn.disabled = false;
            els.downloadTxtBtn.disabled = false;
        } catch (err) {
            lastReport = null;
            els.exportPdfBtn.disabled = true;
            els.downloadTxtBtn.disabled = true;
            showError(err?.name === 'AbortError' ? 'Request timed out. Please try again.' : (err?.message || 'Analysis failed.'));
        } finally {
            setLoading(false);
        }
    }

    els.analyzeBtn.addEventListener('click', analyze);
    els.reanalyzeBtn.addEventListener('click', () => {
        if (lastUrl) {
            els.url.value = lastUrl;
            analyze();
        }
    });
    els.exportPdfBtn.addEventListener('click', exportPdf);
    els.downloadTxtBtn.addEventListener('click', downloadText);

    renderScore(0);
</script>
</body>
</html>
