<?php
session_start();

if (!isset($_SESSION['user_id'])) {
    die('User not logged in');
}

$usersPath = '../../../userdata.json';
$user_data_json = @file_get_contents($usersPath);
$readusers_data = json_decode($user_data_json, true);

$user_found = false;
$user_data = null;

foreach ($readusers_data as &$user) {
    if ($user['id'] == $_SESSION['user_id']) {
        $user_data = $user;
        $user_found = true;
        $user['lastseen_date'] = date('Y-m-d H:i:s');
        break;
    }
}
if (!$user_found) {
    die('User data not found');
}

$plans = json_decode(@file_get_contents('../../../plans.json'), true);
$selectedPlan = null;
foreach ($plans as $plan) {
    if ($plan['plan'] === $user_data['plan_type']) {
        $selectedPlan = $plan;
        break;
    }
}
if (!$selectedPlan) {
    die('Invalid plan type');
}

$configFilePath = './conf.json';
$configContent = @file_get_contents($configFilePath);
$config = json_decode($configContent ?: '[]', true);
if (!is_array($config) || !isset($config[0])) {
    die('Error loading configuration.');
}

$chatbotConfig = $config[0];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && empty($_FILES)) {
    header('Content-Type: application/json');
    $credits = (int)($chatbotConfig['credits_count'] ?? 0);
    if ($credits > 0) {
        $credits -= 1;
        $chatbotConfig['credits_count'] = $credits;
        $config[0] = $chatbotConfig;
        @file_put_contents($configFilePath, json_encode($config, JSON_PRETTY_PRINT));
        echo json_encode(['status' => 'success', 'credits_count' => $credits]);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Insufficient credits.']);
    }
    exit;
}

$backgroundColor = $chatbotConfig['background_color'] ?? '#ffffff';
$styleColor = $chatbotConfig['style_color'] ?? '#0000ff';
$textColor = $chatbotConfig['text_color'] ?? '#000000';
$chatbotName = $chatbotConfig['chatbot_name'] ?? 'Conversational AI';
$chatbotHeading = $chatbotConfig['header'] ?? 'Chat Assistant';
$chatbotId = $chatbotConfig['chatbot_id'] ?? '';
$chatbotKey = $chatbotConfig['chatbot_apikey'] ?? '';
$chatbotImg = !empty($chatbotConfig['img_url']) ? $chatbotConfig['img_url'] : 'default.png';
$creditsCount = (int)($chatbotConfig['credits_count'] ?? 0);

function getFullPath() {
    $protocol = "https://";
    $host = $_SERVER['HTTP_HOST'];
    $currentPath = rtrim(dirname($_SERVER['PHP_SELF']), '/');
    return $protocol . $host . $currentPath;
}

// Resident memory logic
if ($selectedPlan['plan'] === 'Gold') {
    $hasResidentMemory = true;
    $maxResidentMemoryMB = 20;
} elseif ($selectedPlan['plan'] === 'Platinum') {
    $hasResidentMemory = true;
    $maxResidentMemoryMB = 40;
} else {
    $hasResidentMemory = false;
    $maxResidentMemoryMB = 0;
}

$directory = 'resident_memory';
$files = [];
$totalSize = 0;
if (is_dir($directory)) {
    $files = array_filter(scandir($directory), function($file) {
        return pathinfo($file, PATHINFO_EXTENSION) === 'txt';
    });
    foreach ($files as $file) {
        $totalSize += filesize($directory . '/' . $file);
    }
}
$totalSizeMB = $totalSize / (1024 * 1024);
$showFileList = !empty($files);

@file_put_contents($usersPath, json_encode($readusers_data, JSON_PRETTY_PRINT));
?>

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><?php echo htmlspecialchars($chatbotName); ?><?php echo $chatbotId ? ' - ' . htmlspecialchars($chatbotId) : ''; ?></title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root {
            --cb-bg: <?php echo htmlspecialchars($backgroundColor); ?>;
            --cb-text: <?php echo htmlspecialchars($textColor); ?>;
            --cb-accent: <?php echo htmlspecialchars($styleColor); ?>;
        }

        body {
            background: var(--cb-bg);
            color: var(--cb-text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .accent { color: var(--cb-accent); }
        .btn-accent { background: var(--cb-accent); border-color: var(--cb-accent); color: #fff; }
        .btn-accent:hover { filter: brightness(0.95); color: #fff; }

        .navbar { 
            z-index: 1030; 
            background: rgba(255,255,255,0.9); 
            backdrop-filter: blur(10px);
        }
        
        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 1.5rem;
            display: none;
        }

        @media (min-width: 992px) {
            .sidebar { display: block; }
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            position: relative;
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message-bubble {
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: 1.2rem;
            position: relative;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .message-guest {
            align-self: flex-end;
            background: var(--cb-accent);
            color: #fff;
            border-bottom-right-radius: 0.2rem;
        }

        .message-bot {
            align-self: flex-start;
            background: #f8f9fa;
            color: #212529;
            border-bottom-left-radius: 0.2rem;
            border: 1px solid rgba(0,0,0,0.08);
        }

        .input-area {
            padding: 1.5rem 2rem;
            background: #fff;
            border-top: 1px solid rgba(0,0,0,0.08);
        }

        .tool-card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.08);
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .tool-card h6 {
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 1rem;
            color: #868e96;
        }

        .file-link {
            cursor: pointer;
            color: var(--cb-accent);
            text-decoration: none;
            display: block;
            padding: 6px 0;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: opacity 0.2s;
        }

        .file-link:hover { opacity: 0.7; }

        .preloader { width: 32px; height: 32px; }

        .loading-dots span {
            animation: blink 1.4s infinite both;
            font-size: 1.4rem;
        }
        .loading-dots span:nth-child(2) { animation-delay: .2s; }
        .loading-dots span:nth-child(3) { animation-delay: .4s; }
        @keyframes blink {
            0% { opacity: .2; }
            20% { opacity: 1; }
            100% { opacity: .2; }
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: -2.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-bubble:hover .copy-btn { opacity: 1; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg border-bottom shadow-sm">
    <div class="container-fluid px-4">
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-sm btn-outline-secondary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMobile">
                Menu
            </button>
            <img src="<?php echo htmlspecialchars($chatbotImg); ?>" alt="Avatar" width="44" height="44" class="rounded-circle border" />
            <div>
                <div class="fw-bold lh-1"><?php echo htmlspecialchars($chatbotHeading); ?></div>
                <div class="small text-secondary mt-1" style="font-size: 0.75rem;">Credits: <span id="creditsCount"><?php echo (int)$creditsCount; ?></span></div>
            </div>
        </div>
    </div>
</nav>

<main>
    <!-- Desktop Sidebar -->
    <aside class="sidebar bg-light">
        <?php include_sidebar_content($selectedPlan, $showFileList, $files, $totalSizeMB, $maxResidentMemoryMB); ?>
    </aside>

    <!-- Mobile Sidebar (Offcanvas) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMobile" style="width: 300px;">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title fw-bold">Chat Tools</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body bg-light">
            <?php include_sidebar_content($selectedPlan, $showFileList, $files, $totalSizeMB, $maxResidentMemoryMB); ?>
        </div>
    </div>

    <section class="chat-area">
        <div id="chat-container">
            <!-- Welcome message -->
            <div class="message-bubble message-bot shadow-sm">
                <div class="fw-bold small mb-1 accent"><?php echo htmlspecialchars($chatbotName); ?></div>
                Hello! I'm your AI assistant. Select a personality or just start chatting!
            </div>
        </div>

        <div class="input-area">
            <div id="errorBox" class="alert alert-danger d-none mb-3 small"></div>
            <div class="input-group">
                <input type="text" id="user-input" class="form-control py-2 shadow-none border-secondary-subtle" placeholder="Ask me anything..." autocomplete="off" />
                <button class="btn btn-accent px-4 fw-semibold" type="button" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </section>
</main>

<?php
function include_sidebar_content($selectedPlan, $showFileList, $files, $totalSizeMB, $maxResidentMemoryMB) {
    ?>
    <div class="tool-card">
        <h6>Personality</h6>
        <select id="selectOption" class="form-select form-select-sm shadow-none">
            <option value="default" selected>General Assistant</option>
            <?php
            $p = $selectedPlan['plan'];
            echo '<option value="01">Full Stack Developer</option>';
            if ($p !== 'Free') {
                echo '<option value="03">Music Expert</option>';
                echo '<option value="05">Multi Languages Translator</option>';
            }
            if ($p === 'Gold' || $p === 'Platinum') {
                echo '<option value="02">AI Expert</option>';
                echo '<option value="04">Movie Expert</option>';
            }
            if ($p === 'Platinum') {
                echo '<option value="06">XVII Century Poet</option>';
            }
            ?>
        </select>
    </div>

    <?php if ($selectedPlan['plan'] !== 'Free' && $selectedPlan['plan'] !== 'Silver'): ?>
    <div class="tool-card">
        <h6>TXT Analyzer</h6>
        <form id="txtUploadForm" enctype="multipart/form-data">
            <input class="form-control form-control-sm mb-2 shadow-none" type="file" accept=".txt,.html,.js,.css,.json" name="file" id="file-input">
            <div id="feedback" class="small text-muted mb-2" style="font-size: 0.7rem;"></div>
            <div class="d-grid gap-2">
                <button id="uploadBtn" class="btn btn-sm btn-outline-secondary" type="submit">Upload File</button>
                <button type="button" class="btn btn-sm btn-accent" id="analyzeBtn" onclick="analyzeFile();" disabled>Analyze File</button>
            </div>
        </form>
    </div>
    <?php endif; ?>

    <?php if ($selectedPlan['plan'] === 'Platinum'): ?>
    <div class="tool-card">
        <h6>Image Analyzer</h6>
        <form id="imgUploadForm" enctype="multipart/form-data">
            <input class="form-control form-control-sm mb-2 shadow-none" type="file" accept=".jpg,.png,.jpeg" name="file" id="vfile-input">
            <div id="vfeedback" class="small text-muted mb-2" style="font-size: 0.7rem;"></div>
            <div class="d-grid gap-2">
                <button id="vuploadBtn" class="btn btn-sm btn-outline-secondary" type="submit">Upload Image</button>
                <button type="button" class="btn btn-sm btn-accent" id="vAnalyzeBtn" onclick="getChatGPTResponseIMG();" disabled>Analyze Image</button>
            </div>
        </form>
    </div>
    <?php endif; ?>

    <?php if ($selectedPlan['plan'] !== 'Free'): ?>
    <div class="tool-card">
        <h6>History Management</h6>
        <div class="d-grid gap-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="saveChatContentTxt()">Export Chat (TXT)</button>
            <?php if ($selectedPlan['plan'] !== 'Silver'): ?>
            <button class="btn btn-sm btn-outline-secondary" id="savetodisk" onclick="saveChatResMem()">Save to Memory</button>
            <?php endif; ?>
        </div>
    </div>
    <?php endif; ?>

    <?php if ($selectedPlan['plan'] === 'Gold' || $selectedPlan['plan'] === 'Platinum'): ?>
    <div class="tool-card">
        <h6>Resident Memory</h6>
        <div id="resmem-list" class="mb-3" style="max-height: 120px; overflow-y: auto;">
            <?php if ($showFileList): ?>
                <?php foreach ($files as $file): ?>
                    <span class="file-link" data-file="<?php echo htmlspecialchars($file); ?>"><?php echo htmlspecialchars($file); ?></span>
                <?php endforeach; ?>
            <?php else: ?>
                <div class="small text-muted" style="font-size: 0.75rem;">No saved files yet.</div>
            <?php endif; ?>
        </div>
        <div class="progress mb-1" style="height: 4px;">
            <?php $percent = min(100, ($totalSizeMB / $maxResidentMemoryMB) * 100); ?>
            <div class="progress-bar bg-accent" role="progressbar" style="width: <?php echo $percent; ?>%"></div>
        </div>
        <div class="d-flex justify-content-between text-muted" style="font-size: 0.65rem;">
            <span>Used: <?php echo round($totalSizeMB, 2); ?> MB</span>
            <span>Limit: <?php echo $maxResidentMemoryMB; ?> MB</span>
        </div>
    </div>
    <?php endif; ?>
    <?php
}
?>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const apikey = <?php echo json_encode($chatbotKey); ?>;
    const chatbotName = <?php echo json_encode($chatbotName); ?>;
    const maxChars = <?php echo ($selectedPlan['plan'] === 'Gold') ? 15000 : (($selectedPlan['plan'] === 'Platinum') ? 30000 : 15000); ?>;
    let chatMemory = [];
    let uploadedFileUrl = "";
    let uploadedImgUrl = "";

    // --- Chat Engine ---

    async function decrementCredits() {
        const res = await fetch(window.location.href, { method: 'POST' });
        const data = await res.json().catch(() => null);
        if (data?.status === 'success') {
            document.getElementById('creditsCount').textContent = data.credits_count;
        } else if (data?.status === 'error') {
            throw new Error(data.message);
        }
    }

    function showMessage(sender, message, isHtml = false) {
        const container = document.getElementById('chat-container');
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${sender === 'Guest' ? 'message-guest' : 'message-bot'}`;
        
        const header = document.createElement('div');
        header.className = 'fw-bold small mb-1 ' + (sender === 'Guest' ? 'text-white-50' : 'accent');
        header.textContent = sender;
        bubble.appendChild(header);

        const content = document.createElement('div');
        if (isHtml) {
            content.innerHTML = message;
        } else {
            // Simple markdown-ish code blocks
            if (message.includes('```')) {
                content.innerHTML = message.replace(/```([\s\S]*?)```/g, '<pre class="bg-dark text-white p-2 rounded my-2 small" style="white-space: pre-wrap;"><code>$1</code></pre>');
            } else {
                content.textContent = message;
            }
        }
        bubble.appendChild(content);

        // Copy button for bot messages
        if (sender !== 'Guest') {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-sm btn-light border copy-btn';
            copyBtn.innerHTML = 'Copy';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(message);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy', 2000);
            };
            bubble.appendChild(copyBtn);
        }

        container.appendChild(bubble);
        container.scrollTop = container.scrollHeight;
    }

    function showTyping() {
        const container = document.getElementById('chat-container');
        const typing = document.createElement('div');
        typing.id = 'typing-indicator';
        typing.className = 'message-bubble message-bot loading-dots';
        typing.innerHTML = 'Assistant is thinking<span>.</span><span>.</span><span>.</span>';
        container.appendChild(typing);
        container.scrollTop = container.scrollHeight;
    }

    function hideTyping() {
        const el = document.getElementById('typing-indicator');
        if (el) el.remove();
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        input.value = '';
        showMessage('Guest', text);
        showTyping();
        document.getElementById('errorBox').classList.add('d-none');

        try {
            await decrementCredits();
            chatMemory.push({ role: 'user', content: text });
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apikey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: chatMemory,
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });

            const data = await response.json();
            hideTyping();

            if (!response.ok) throw new Error(data?.error?.message || 'OpenAI API Error');

            const aiMsg = data.choices[0].message.content.trim();
            showMessage(chatbotName, aiMsg);
            chatMemory.push({ role: 'assistant', content: aiMsg });

            // Manage memory
            if (chatMemory.length > 20) chatMemory = [chatMemory[0], ...chatMemory.slice(-19)];

        } catch (err) {
            hideTyping();
            document.getElementById('errorBox').textContent = err.message;
            document.getElementById('errorBox').classList.remove('d-none');
        }
    }

    // --- Personality Logic ---

    function updateStructure() {
        const val = document.getElementById('selectOption').value;
        const def = getDefinition(val);
        chatMemory = [{ role: 'system', content: def }];
        
        const container = document.getElementById('chat-container');
        const info = document.createElement('div');
        info.className = 'text-center my-3 small text-muted text-uppercase fw-bold letter-spacing-1';
        info.textContent = '--- Personality Switched to ' + document.getElementById('selectOption').options[document.getElementById('selectOption').selectedIndex].text + ' ---';
        container.appendChild(info);
        container.scrollTop = container.scrollHeight;
    }

    function getDefinition(val) {
        const defs = {
            '01': "You are a full stack developer. Answer only software/web related questions.",
            '02': "You are an AI expert. Answer only AI related questions.",
            '03': "You are Alex, a music expert with deep knowledge of 80s/90s pop and rock.",
            '04': "You are a movie expert who knows plots, cast, and styles perfectly.",
            '05': "You are a multi-language translator. Help with translations and explain idioms.",
            '06': "You are a XVII century poet. Always answer in rhyme with period-appropriate lexicon."
        };
        return defs[val] || "You are a helpful conversational AI.";
    }

    // --- Analysis Logic ---

    async function analyzeFile() {
        if (!uploadedFileUrl) return;
        showTyping();
        try {
            const fullUrl = "<?php echo getFullPath(); ?>/" + uploadedFileUrl;
            const response = await fetch(fullUrl);
            const content = await response.text();
            
            if (content.length > maxChars) {
                throw new Error("File too large (max " + maxChars + " chars).");
            }

            chatMemory.push({ role: 'user', content: "Analyze this file content: " + content });
            const aiRes = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apikey}` },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: chatMemory
                })
            });
            const data = await aiRes.json();
            hideTyping();
            const summary = data.choices[0].message.content;
            showMessage(chatbotName, "File Analysis Summary:\n" + summary);
            chatMemory.push({ role: 'assistant', content: summary });
        } catch (err) {
            hideTyping();
            alert(err.message);
        }
    }

    async function getChatGPTResponseIMG() {
        if (!uploadedImgUrl) return;
        showTyping();
        try {
            const fullUrl = "<?php echo getFullPath(); ?>/" + uploadedImgUrl;
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apikey}` },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        ...chatMemory,
                        {
                            role: "user",
                            content: [
                                { type: "text", text: "What's in this image?" },
                                { type: "image_url", image_url: { url: fullUrl } }
                            ]
                        }
                    ],
                    max_tokens: 500
                })
            });
            const data = await res.json();
            hideTyping();
            const aiMsg = data.choices[0].message.content;
            showMessage(chatbotName, `<div>Image Analysis:</div><img src="${fullUrl}" class="img-fluid rounded my-2 border shadow-sm" style="max-height: 200px" /><br>${aiMsg}`, true);
            chatMemory.push({ role: 'assistant', content: aiMsg });
        } catch (err) {
            hideTyping();
            alert(err.message);
        }
    }

    // --- JQuery for Uploads ---
    $(document).ready(function() {
        $('#uploadBtn').click(function(e) {
            e.preventDefault();
            const formData = new FormData($('#txtUploadForm')[0]);
            $('#feedback').text('Uploading...');
            $.ajax({
                url: 'upload.php',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    const data = JSON.parse(res);
                    if (data.status === "success") {
                        uploadedFileUrl = data.url;
                        $('#feedback').html('<span class="text-success">File uploaded!</span>');
                        $('#analyzeBtn').prop('disabled', false);
                    } else {
                        $('#feedback').html('<span class="text-danger">Upload failed</span>');
                    }
                }
            });
        });

        $('#vuploadBtn').click(function(e) {
            e.preventDefault();
            const formData = new FormData($('#imgUploadForm')[0]);
            $('#vfeedback').text('Uploading...');
            $.ajax({
                url: 'vupload.php',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    const data = JSON.parse(res);
                    if (data.status === "success") {
                        uploadedImgUrl = data.url;
                        $('#vfeedback').html('<span class="text-success">Image uploaded!</span>');
                        $('#vAnalyzeBtn').prop('disabled', false);
                    } else {
                        $('#vfeedback').html('<span class="text-danger">Upload failed</span>');
                    }
                }
            });
        });

        $('.file-link').click(function() {
            const filename = $(this).data('file');
            $.get("resident_memory/" + filename, function(data) {
                $('#chat-container').html(data);
                $('#sidebarMobile').offcanvas('hide');
            });
        });
    });

    // --- Export & Save ---
    function saveChatContentTxt() {
        let content = '';
        $('#chat-container .message-bubble').each(function() {
            const sender = $(this).find('.small.fw-bold').text();
            const text = $(this).find('div:not(.small)').text().trim();
            if (sender) content += `${sender}: ${text}\n\n`;
        });
        const blob = new Blob([content], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `chat_export_${Date.now()}.txt`;
        a.click();
    }

    function saveChatResMem() {
        const content = $('#chat-container').html();
        const filename = 'chat_' + Date.now();
        $.post("save_chat_resmem.php", { content: content, filename: filename }, function() {
            alert("Chat saved to memory!");
            location.reload();
        });
    }

    // Init
    document.getElementById('selectOption').addEventListener('change', updateStructure);
    document.getElementById('user-input').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    updateStructure();
</script>

</body>
</html>
