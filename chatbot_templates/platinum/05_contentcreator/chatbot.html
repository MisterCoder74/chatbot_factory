<?php
session_start();

if (!isset($_SESSION['user_id'])) {
    die('User not logged in');
}

// Update last seen (best-effort)
$usersPath = '../../../userdata.json';
$usersRaw = @file_get_contents($usersPath);
if ($usersRaw !== false) {
    $users = json_decode($usersRaw, true);
    if (is_array($users)) {
        foreach ($users as &$u) {
            if (($u['id'] ?? null) == $_SESSION['user_id']) {
                $u['lastseen_date'] = date('Y-m-d H:i:s');
                break;
            }
        }
        @file_put_contents($usersPath, json_encode($users, JSON_PRETTY_PRINT));
    }
}

$configFilePath = './conf.json';
$configContent = @file_get_contents($configFilePath);
$config = json_decode($configContent ?: '[]', true);
if (!is_array($config) || !isset($config[0])) {
    die('Error loading configuration.');
}

$chatbotConfig = $config[0];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && ($_POST['action'] ?? '') === 'decrement_credits') {
    header('Content-Type: application/json');

    $amount = (int)($_POST['amount'] ?? 1);
    $amount = max(1, min(50, $amount));

    $credits = (int)($chatbotConfig['credits_count'] ?? 0);

    if ($credits < $amount) {
        echo json_encode([
            'status' => 'error',
            'message' => 'Insufficient credits.',
            'credits_count' => $credits
        ]);
        exit;
    }

    $credits -= $amount;
    $chatbotConfig['credits_count'] = $credits;
    $config[0] = $chatbotConfig;
    @file_put_contents($configFilePath, json_encode($config, JSON_PRETTY_PRINT));

    echo json_encode(['status' => 'success', 'credits_count' => $credits]);
    exit;
}

$backgroundColor = $chatbotConfig['background_color'] ?? '#ffffff';
$styleColor = $chatbotConfig['style_color'] ?? '#0066ff';
$textColor = $chatbotConfig['text_color'] ?? '#000000';
$chatbotName = $chatbotConfig['chatbot_name'] ?? 'Content Creator';
$chatbotHeading = $chatbotConfig['header'] ?? 'Content Creator';
$chatbotId = $chatbotConfig['chatbot_id'] ?? '';
$chatbotKey = $chatbotConfig['chatbot_apikey'] ?? '';
$chatbotImg = !empty($chatbotConfig['img_url']) ? $chatbotConfig['img_url'] : 'default.png';
$creditsCount = (int)($chatbotConfig['credits_count'] ?? 0);
?>

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><?php echo htmlspecialchars($chatbotName); ?><?php echo $chatbotId ? ' - ' . htmlspecialchars($chatbotId) : ''; ?></title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root {
            --cb-bg: <?php echo htmlspecialchars($backgroundColor); ?>;
            --cb-text: <?php echo htmlspecialchars($textColor); ?>;
            --cb-accent: <?php echo htmlspecialchars($styleColor); ?>;
        }

        body {
            background: var(--cb-bg);
            color: var(--cb-text);
        }

        .btn-accent {
            background: var(--cb-accent);
            border-color: var(--cb-accent);
            color: #fff;
        }
        .btn-accent:hover { filter: brightness(0.95); color: #fff; }

        .platform-pill .nav-link.active {
            background: var(--cb-accent);
            border-color: var(--cb-accent);
        }

        .post-box {
            white-space: pre-wrap;
            background: #fff;
            border: 1px solid rgba(0,0,0,.12);
            border-radius: 12px;
            padding: 12px;
            min-height: 120px;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
        }
        .loading-overlay img {
            width: 76px;
            height: 76px;
        }

        .tag {
            display: inline-block;
            border: 1px solid rgba(0,0,0,.15);
            border-radius: 999px;
            padding: 4px 10px;
            margin: 3px 6px 0 0;
            background: #fff;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
    <img src="preloader.gif" alt="Loading" />
    <div class="mt-3 fw-semibold">Generating…</div>
</div>

<nav class="navbar navbar-expand-lg border-bottom" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(6px);">
    <div class="container">
        <div class="d-flex align-items-center gap-3">
            <img src="<?php echo htmlspecialchars($chatbotImg); ?>" alt="Avatar" width="44" height="44" class="rounded-circle" />
            <div>
                <div class="fw-bold"><?php echo htmlspecialchars($chatbotHeading); ?></div>
                <div class="small text-secondary">Credits: <span id="creditsCount"><?php echo (int)$creditsCount; ?></span></div>
            </div>
        </div>
    </div>
</nav>

<main class="container py-4">
    <div class="row g-4">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="fw-semibold">Generate optimized content for each platform</div>
                <div class="small">Pick a platform and tone, then generate 3 variations. Copy any version with one click.</div>
            </div>
        </div>

        <div class="col-12 col-lg-5">
            <label class="form-label fw-semibold" for="topic">Topic / idea</label>
            <textarea id="topic" class="form-control" rows="4" placeholder="Example: A new AI breakthrough in healthcare"></textarea>

            <div class="mt-3">
                <div class="fw-semibold mb-2">Platform</div>
                <ul class="nav nav-pills gap-2 platform-pill" id="platformPills">
                    <li class="nav-item"><button class="nav-link active" type="button" data-platform="Twitter/X">Twitter/X</button></li>
                    <li class="nav-item"><button class="nav-link" type="button" data-platform="Instagram">Instagram</button></li>
                    <li class="nav-item"><button class="nav-link" type="button" data-platform="LinkedIn">LinkedIn</button></li>
                    <li class="nav-item"><button class="nav-link" type="button" data-platform="TikTok">TikTok</button></li>
                    <li class="nav-item"><button class="nav-link" type="button" data-platform="Facebook">Facebook</button></li>
                </ul>
            </div>

            <div class="mt-3">
                <label class="form-label fw-semibold" for="tone">Tone</label>
                <select id="tone" class="form-select">
                    <option value="Professional">Professional</option>
                    <option value="Casual">Casual</option>
                    <option value="Humorous">Humorous</option>
                    <option value="Inspirational">Inspirational</option>
                    <option value="Engaging" selected>Engaging</option>
                </select>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-3">
                <button class="btn btn-accent" id="generateBtn">Generate Content</button>
                <button class="btn btn-outline-secondary" id="moreBtn" disabled>Generate More Variations</button>
            </div>

            <div id="errorBox" class="alert alert-danger mt-3 d-none"></div>

            <div class="mt-3">
                <div class="fw-semibold">Hashtag suggestions</div>
                <div id="hashtags" class="mt-2"></div>
            </div>

            <div class="mt-3">
                <div class="fw-semibold">Best posting times</div>
                <div id="bestTimes" class="small text-secondary mt-1">—</div>
            </div>
        </div>

        <div class="col-12 col-lg-7">
            <div class="fw-semibold mb-2">Generated posts</div>
            <div id="posts" class="d-flex flex-column gap-3"></div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const OPENAI_API_KEY = <?php echo json_encode($chatbotKey); ?>;

    const els = {
        topic: document.getElementById('topic'),
        tone: document.getElementById('tone'),
        platformPills: document.getElementById('platformPills'),
        generateBtn: document.getElementById('generateBtn'),
        moreBtn: document.getElementById('moreBtn'),
        posts: document.getElementById('posts'),
        hashtags: document.getElementById('hashtags'),
        bestTimes: document.getElementById('bestTimes'),
        errorBox: document.getElementById('errorBox'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        creditsCount: document.getElementById('creditsCount')
    };

    let selectedPlatform = 'Twitter/X';

    function setLoading(isLoading) {
        els.loadingOverlay.style.display = isLoading ? 'flex' : 'none';
        els.loadingOverlay.setAttribute('aria-hidden', isLoading ? 'false' : 'true');
        els.generateBtn.disabled = isLoading;
        els.moreBtn.disabled = isLoading || els.moreBtn.disabled;
    }

    function showError(message) {
        els.errorBox.textContent = message;
        els.errorBox.classList.remove('d-none');
    }

    function clearError() {
        els.errorBox.classList.add('d-none');
        els.errorBox.textContent = '';
    }

    async function fetchWithTimeout(url, options = {}, timeoutMs = 120000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
            return res;
        } finally {
            clearTimeout(timeoutId);
        }
    }

    async function decrementCredits(amount = 1) {
        const formData = new FormData();
        formData.append('action', 'decrement_credits');
        formData.append('amount', String(amount));

        const res = await fetchWithTimeout(window.location.href, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        }, 30000);

        const data = await res.json().catch(() => null);
        if (!data || data.status !== 'success') {
            const msg = data?.message || 'Unable to update credits.';
            throw new Error(msg);
        }

        els.creditsCount.textContent = String(data.credits_count);
    }

    function wordCount(text) {
        const trimmed = (text || '').trim();
        if (!trimmed) return 0;
        return trimmed.split(/\s+/).length;
    }

    function platformInstruction(platform) {
        switch (platform) {
            case 'Twitter/X':
                return 'Generate a compelling tweet (max 280 characters). Include 2-4 relevant/trending hashtags. Keep it concise and engaging.';
            case 'Instagram':
                return 'Generate an engaging Instagram caption with emojis and hashtags (max 2200 characters). Optimize for reach and engagement.';
            case 'LinkedIn':
                return 'Generate a professional LinkedIn post with clear business value, a call-to-action, and relevant industry hashtags.';
            case 'TikTok':
                return 'Generate a trendy, engaging TikTok script idea. Include: hook, script beats, on-screen text suggestions, and a music/sound suggestion. Include hashtags.';
            case 'Facebook':
                return 'Generate shareable Facebook content that encourages community engagement. Longer form is allowed (max 5000 characters). Include hashtags.';
            default:
                return 'Generate platform-optimized social media content.';
        }
    }

    function bestTimesSuggestion(platform) {
        switch (platform) {
            case 'Twitter/X': return ['Weekdays 8–10am', 'Weekdays 12–1pm', 'Weekdays 5–6pm'];
            case 'Instagram': return ['Tue–Thu 11am–1pm', 'Wed 6–8pm', 'Sat 10–11am'];
            case 'LinkedIn': return ['Tue–Thu 8–10am', 'Tue–Thu 12pm', 'Wed 3–5pm'];
            case 'TikTok': return ['Mon–Thu 6–10pm', 'Sat 9–11am', 'Sun 7–9pm'];
            case 'Facebook': return ['Tue–Thu 9–1pm', 'Wed 5–7pm', 'Sat 10–12am'];
            default: return ['Weekdays midday'];
        }
    }

    function renderHashtags(tags) {
        els.hashtags.innerHTML = '';
        const list = Array.isArray(tags) ? tags : [];
        if (!list.length) {
            els.hashtags.innerHTML = '<div class="small text-secondary">—</div>';
            return;
        }

        const wrap = document.createElement('div');
        list.forEach((t) => {
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = t;
            wrap.appendChild(span);
        });
        els.hashtags.appendChild(wrap);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn btn-sm btn-outline-secondary mt-2';
        copyBtn.textContent = 'Copy hashtags';
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(list.join(' '));
                copyBtn.textContent = 'Copied';
                setTimeout(() => (copyBtn.textContent = 'Copy hashtags'), 900);
            } catch {
                showError('Copy failed.');
            }
        });
        els.hashtags.appendChild(copyBtn);
    }

    function renderPosts(platform, posts) {
        els.posts.innerHTML = '';

        (posts || []).forEach((p, idx) => {
            const text = (p?.text || '').trim();
            const hashtags = Array.isArray(p?.hashtags) ? p.hashtags : [];

            const chars = text.length;
            const words = wordCount(text);

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start gap-3">
                        <div>
                            <div class="fw-semibold">${platform} – Variation ${idx + 1}</div>
                            <div class="small text-secondary">${chars} chars • ${words} words • ${hashtags.length} hashtags</div>
                        </div>
                        <button class="btn btn-sm btn-accent" data-copy="${idx}">Copy</button>
                    </div>
                    <div class="post-box mt-3" id="post_${idx}"></div>
                </div>
            `;

            card.querySelector(`#post_${idx}`).textContent = text;

            card.querySelector('[data-copy]').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                try {
                    await navigator.clipboard.writeText(text);
                    btn.textContent = 'Copied';
                    setTimeout(() => (btn.textContent = 'Copy'), 900);
                } catch {
                    showError('Copy failed.');
                }
            });

            els.posts.appendChild(card);
        });
    }

    async function generate(variationCount = 3) {
        clearError();

        if (!OPENAI_API_KEY || !OPENAI_API_KEY.trim()) {
            showError('Missing OpenAI API key. Please add it from the Edit Chatbot page.');
            return;
        }

        const topic = els.topic.value.trim();
        if (!topic) {
            showError('Please enter a topic/idea.');
            return;
        }

        const tone = els.tone.value;
        const platform = selectedPlatform;

        setLoading(true);

        try {
            await decrementCredits(1);

            const schemaHint = {
                platform: platform,
                tone: tone,
                posts: [
                    { text: '...', hashtags: ['#tag1', '#tag2'] }
                ],
                hashtag_suggestions: ['#tag1', '#tag2'],
                best_posting_times: ['...']
            };

            const body = {
                model: 'gpt-4o-mini',
                messages: [
                    {
                        role: 'system',
                        content: 'You are a senior social media strategist. Return ONLY valid JSON. Do not include markdown or code fences. Ensure the JSON is parseable.'
                    },
                    {
                        role: 'user',
                        content: `Topic: ${topic}\nPlatform: ${platform}\nTone: ${tone}\n\nPlatform instructions: ${platformInstruction(platform)}\n\nGenerate ${variationCount} distinct variations.\n\nReturn JSON exactly like this shape (keys must match):\n${JSON.stringify(schemaHint, null, 2)}`
                    }
                ],
                temperature: 0.8,
                max_tokens: 900
            };

            const res = await fetchWithTimeout('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify(body)
            }, 120000);

            const payload = await res.json().catch(() => null);
            if (!res.ok) {
                const msg = payload?.error?.message || `OpenAI request failed (HTTP ${res.status}).`;
                throw new Error(msg);
            }

            const content = payload?.choices?.[0]?.message?.content || '';
            let data;
            try {
                data = JSON.parse(content);
            } catch {
                throw new Error('Invalid AI response format (expected JSON). Please try again.');
            }

            const posts = Array.isArray(data.posts) ? data.posts.slice(0, variationCount) : [];
            const tags = Array.isArray(data.hashtag_suggestions) ? data.hashtag_suggestions : [];

            renderPosts(platform, posts);
            renderHashtags(tags);

            const times = Array.isArray(data.best_posting_times) && data.best_posting_times.length
                ? data.best_posting_times
                : bestTimesSuggestion(platform);
            els.bestTimes.textContent = times.join(' • ');

            els.moreBtn.disabled = false;
        } catch (err) {
            showError(err?.name === 'AbortError' ? 'Request timed out. Please try again.' : (err?.message || 'Generation failed.'));
        } finally {
            setLoading(false);
        }
    }

    els.platformPills.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-platform]');
        if (!btn) return;

        selectedPlatform = btn.getAttribute('data-platform');
        [...els.platformPills.querySelectorAll('.nav-link')].forEach((x) => x.classList.remove('active'));
        btn.classList.add('active');

        els.bestTimes.textContent = bestTimesSuggestion(selectedPlatform).join(' • ');
    });

    els.bestTimes.textContent = bestTimesSuggestion(selectedPlatform).join(' • ');

    els.generateBtn.addEventListener('click', () => generate(3));
    els.moreBtn.addEventListener('click', () => generate(3));
</script>
</body>
</html>
