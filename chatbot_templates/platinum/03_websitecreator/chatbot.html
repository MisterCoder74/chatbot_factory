<?php
session_start();

if (!isset($_SESSION['user_id'])) {
    die('User not logged in');
}

// Update last seen (best-effort)
$usersPath = '../../../userdata.json';
$usersRaw = @file_get_contents($usersPath);
if ($usersRaw !== false) {
    $users = json_decode($usersRaw, true);
    if (is_array($users)) {
        foreach ($users as &$u) {
            if (($u['id'] ?? null) == $_SESSION['user_id']) {
                $u['lastseen_date'] = date('Y-m-d H:i:s');
                break;
            }
        }
        @file_put_contents($usersPath, json_encode($users, JSON_PRETTY_PRINT));
    }
}

$configFilePath = './conf.json';
$configContent = @file_get_contents($configFilePath);
$config = json_decode($configContent ?: '[]', true);
if (!is_array($config) || !isset($config[0])) {
    die('Error loading configuration.');
}

$chatbotConfig = $config[0];

if ($_SERVER['REQUEST_METHOD'] === 'POST' && ($_POST['action'] ?? '') === 'decrement_credits') {
    header('Content-Type: application/json');

    $amount = (int)($_POST['amount'] ?? 1);
    $amount = max(1, min(50, $amount));

    $credits = (int)($chatbotConfig['credits_count'] ?? 0);

    if ($credits < $amount) {
        echo json_encode([
            'status' => 'error',
            'message' => 'Insufficient credits.',
            'credits_count' => $credits
        ]);
        exit;
    }

    $credits -= $amount;
    $chatbotConfig['credits_count'] = $credits;
    $config[0] = $chatbotConfig;
    @file_put_contents($configFilePath, json_encode($config, JSON_PRETTY_PRINT));

    echo json_encode(['status' => 'success', 'credits_count' => $credits]);
    exit;
}

$backgroundColor = $chatbotConfig['background_color'] ?? '#ffffff';
$styleColor = $chatbotConfig['style_color'] ?? '#00aa00';
$textColor = $chatbotConfig['text_color'] ?? '#000000';
$chatbotName = $chatbotConfig['chatbot_name'] ?? 'Website Composer';
$chatbotHeading = $chatbotConfig['header'] ?? 'Website Composer';
$chatbotId = $chatbotConfig['chatbot_id'] ?? '';
$chatbotKey = $chatbotConfig['chatbot_apikey'] ?? '';
$chatbotImg = !empty($chatbotConfig['img_url']) ? $chatbotConfig['img_url'] : 'default.png';
$creditsCount = (int)($chatbotConfig['credits_count'] ?? 0);
?>

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><?php echo htmlspecialchars($chatbotName); ?><?php echo $chatbotId ? ' - ' . htmlspecialchars($chatbotId) : ''; ?></title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        :root {
            --cb-bg: <?php echo htmlspecialchars($backgroundColor); ?>;
            --cb-text: <?php echo htmlspecialchars($textColor); ?>;
            --cb-accent: <?php echo htmlspecialchars($styleColor); ?>;
        }

        body {
            background: var(--cb-bg);
            color: var(--cb-text);
        }

        .accent {
            color: var(--cb-accent);
        }

        .btn-accent {
            background: var(--cb-accent);
            border-color: var(--cb-accent);
            color: #fff;
        }

        .btn-accent:hover {
            filter: brightness(0.95);
            color: #fff;
        }

        .codebox {
            background: #0b1020;
            color: #e8e8e8;
            border-radius: 12px;
            padding: 12px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9rem;
            white-space: pre;
            overflow: auto;
            min-height: 260px;
        }

        .preview-frame {
            width: 100%;
            height: 520px;
            border: 1px solid rgba(0,0,0,.15);
            border-radius: 12px;
            background: #fff;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
        }

        .loading-overlay img {
            width: 76px;
            height: 76px;
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
    <img src="preloader.gif" alt="Loading" />
    <div class="mt-3 fw-semibold">Generatingâ€¦</div>
</div>

<nav class="navbar navbar-expand-lg border-bottom" style="background: rgba(255,255,255,0.8); backdrop-filter: blur(6px);">
    <div class="container">
        <div class="d-flex align-items-center gap-3">
            <img src="<?php echo htmlspecialchars($chatbotImg); ?>" alt="Avatar" width="44" height="44" class="rounded-circle" />
            <div>
                <div class="fw-bold"><?php echo htmlspecialchars($chatbotHeading); ?></div>
                <div class="small text-secondary">Credits: <span id="creditsCount"><?php echo (int)$creditsCount; ?></span></div>
            </div>
        </div>
    </div>
</nav>

<main class="container py-4">
    <div class="row g-4">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="fw-semibold">How it works</div>
                <div class="small">Describe the website you want. The assistant returns production-ready HTML/CSS/JS and a live preview.</div>
            </div>
        </div>

        <div class="col-12">
            <label for="prompt" class="form-label fw-semibold">Website description</label>
            <textarea id="prompt" class="form-control" rows="4" placeholder="Example: Create a portfolio website for a photographer with gallery and contact form"></textarea>
            <div class="d-flex flex-wrap gap-2 mt-3">
                <button id="generateBtn" class="btn btn-accent">Generate Website</button>
                <button id="downloadBtn" class="btn btn-outline-secondary" disabled>Download HTML</button>
            </div>
            <div id="errorBox" class="alert alert-danger mt-3 d-none"></div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="fw-semibold">Generated code</div>
            </div>

            <ul class="nav nav-tabs" id="codeTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="html-tab" data-bs-toggle="tab" data-bs-target="#html" type="button" role="tab">HTML</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="css-tab" data-bs-toggle="tab" data-bs-target="#css" type="button" role="tab">CSS</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="js-tab" data-bs-toggle="tab" data-bs-target="#js" type="button" role="tab">JavaScript</button>
                </li>
            </ul>

            <div class="tab-content border border-top-0 rounded-bottom p-3" style="background:#fff;">
                <div class="tab-pane fade show active" id="html" role="tabpanel">
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-sm btn-outline-secondary" data-copy="html">Copy HTML</button>
                    </div>
                    <pre class="codebox" id="htmlCode"></pre>
                </div>
                <div class="tab-pane fade" id="css" role="tabpanel">
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-sm btn-outline-secondary" data-copy="css">Copy CSS</button>
                    </div>
                    <pre class="codebox" id="cssCode"></pre>
                </div>
                <div class="tab-pane fade" id="js" role="tabpanel">
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-sm btn-outline-secondary" data-copy="js">Copy JS</button>
                    </div>
                    <pre class="codebox" id="jsCode"></pre>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="fw-semibold mb-2">Live preview</div>
            <iframe id="preview" class="preview-frame" title="Website preview"></iframe>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const OPENAI_API_KEY = <?php echo json_encode($chatbotKey); ?>;

    const SYSTEM_PROMPT = `You are an expert fullstack web developer. When given a website description, generate ONLY complete, production-ready HTML+CSS+JavaScript code that:
1. Is fully self-contained (no external dependencies except Bootstrap 5 CDN)
2. Has responsive design for mobile/tablet/desktop
3. Includes semantic HTML5
4. Has modern, professional styling
5. Includes interactive features via vanilla JavaScript

Return ONLY valid code wrapped in markers:
<HTML_START>
...html code...
<HTML_END>

<CSS_START>
...css code...
<CSS_END>

<JS_START>
...javascript code...
<JS_END>`;

    const els = {
        prompt: document.getElementById('prompt'),
        generateBtn: document.getElementById('generateBtn'),
        downloadBtn: document.getElementById('downloadBtn'),
        htmlCode: document.getElementById('htmlCode'),
        cssCode: document.getElementById('cssCode'),
        jsCode: document.getElementById('jsCode'),
        preview: document.getElementById('preview'),
        errorBox: document.getElementById('errorBox'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        creditsCount: document.getElementById('creditsCount')
    };

    let lastGenerated = { html: '', css: '', js: '', full: '' };

    function setLoading(isLoading) {
        els.loadingOverlay.style.display = isLoading ? 'flex' : 'none';
        els.loadingOverlay.setAttribute('aria-hidden', isLoading ? 'false' : 'true');
        els.generateBtn.disabled = isLoading;
    }

    function showError(message) {
        els.errorBox.textContent = message;
        els.errorBox.classList.remove('d-none');
    }

    function clearError() {
        els.errorBox.classList.add('d-none');
        els.errorBox.textContent = '';
    }

    async function fetchWithTimeout(url, options = {}, timeoutMs = 120000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
            return res;
        } finally {
            clearTimeout(timeoutId);
        }
    }

    function extractSection(text, startMarker, endMarker) {
        const start = text.indexOf(startMarker);
        const end = text.indexOf(endMarker);
        if (start === -1 || end === -1 || end <= start) return '';
        return text.substring(start + startMarker.length, end).trim();
    }

    function buildPreviewDocument(html, css, js) {
        const bootstrap = '<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">';
        const cssTag = `<style>\n${css}\n</style>`;
        const jsTag = `<script>\n${js}\n<\/script>`;

        const hasHtml = /<html[\s>]/i.test(html) && /<\/html>/i.test(html);
        if (hasHtml) {
            let doc = html;
            if (/<\/head>/i.test(doc)) doc = doc.replace(/<\/head>/i, `${bootstrap}\n${cssTag}\n</head>`);
            else doc = `${bootstrap}\n${cssTag}\n` + doc;

            if (/<\/body>/i.test(doc)) doc = doc.replace(/<\/body>/i, `${jsTag}\n</body>`);
            else doc += `\n${jsTag}`;

            return doc;
        }

        return `<!doctype html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1">\n${bootstrap}\n${cssTag}\n</head>\n<body>\n${html}\n${jsTag}\n</body>\n</html>`;
    }

    async function decrementCredits(amount = 1) {
        const formData = new FormData();
        formData.append('action', 'decrement_credits');
        formData.append('amount', String(amount));

        const res = await fetchWithTimeout(window.location.href, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        }, 30000);

        const data = await res.json().catch(() => null);
        if (!data || data.status !== 'success') {
            const msg = data?.message || 'Unable to update credits.';
            throw new Error(msg);
        }

        els.creditsCount.textContent = String(data.credits_count);
    }

    async function generateWebsite() {
        clearError();

        const prompt = els.prompt.value.trim();
        if (!prompt) {
            showError('Please enter a website description prompt.');
            return;
        }

        if (!OPENAI_API_KEY || !OPENAI_API_KEY.trim()) {
            showError('Missing OpenAI API key. Please add it from the Edit Chatbot page.');
            return;
        }

        setLoading(true);

        try {
            await decrementCredits(1);

            const body = {
                model: 'gpt-4o-mini',
                messages: [
                    { role: 'system', content: SYSTEM_PROMPT },
                    { role: 'user', content: prompt }
                ],
                temperature: 0.2,
                max_tokens: 4096
            };

            const res = await fetchWithTimeout('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify(body)
            }, 180000);

            const payload = await res.json().catch(() => null);
            if (!res.ok) {
                const msg = payload?.error?.message || `OpenAI request failed (HTTP ${res.status}).`;
                throw new Error(msg);
            }

            const content = payload?.choices?.[0]?.message?.content || '';
            const html = extractSection(content, '<HTML_START>', '<HTML_END>');
            const css = extractSection(content, '<CSS_START>', '<CSS_END>');
            const js = extractSection(content, '<JS_START>', '<JS_END>');

            if (!html && !css && !js) {
                throw new Error('Invalid response: missing code markers. Please try again with a more specific prompt.');
            }

            const full = buildPreviewDocument(html, css, js);

            lastGenerated = { html, css, js, full };

            els.htmlCode.textContent = html || '';
            els.cssCode.textContent = css || '';
            els.jsCode.textContent = js || '';
            els.preview.srcdoc = full;

            els.downloadBtn.disabled = !full;
        } catch (err) {
            showError(err?.name === 'AbortError' ? 'Request timed out. Please try again.' : (err?.message || 'Unknown error.'));
        } finally {
            setLoading(false);
        }
    }

    function downloadHtml() {
        if (!lastGenerated.full) return;
        const blob = new Blob([lastGenerated.full], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'generated_website.html';
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);
    }

    async function copyText(text) {
        if (!text) return;
        await navigator.clipboard.writeText(text);
    }

    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('[data-copy]');
        if (!btn) return;

        const key = btn.getAttribute('data-copy');
        const text = key === 'html' ? lastGenerated.html : key === 'css' ? lastGenerated.css : lastGenerated.js;

        try {
            await copyText(text);
            btn.textContent = 'Copied';
            setTimeout(() => (btn.textContent = `Copy ${key.toUpperCase()}`), 900);
        } catch {
            showError('Copy failed. Your browser may block clipboard access.');
        }
    });

    els.generateBtn.addEventListener('click', generateWebsite);
    els.downloadBtn.addEventListener('click', downloadHtml);
</script>
</body>
</html>
